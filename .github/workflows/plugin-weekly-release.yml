name: Plugin Weekly Release

on:
  workflow_call:
    inputs:
      plugin_name:
        description: "Name of the plugin (e.g., flashcards)"
        required: true
        type: string
      release_channel:
        description: "Release channel (alpha/beta/stable)"
        required: false
        type: string
        default: "alpha"
    secrets:
      RIMORI_TOKEN:
        required: true
      SLACK_BOT_TOKEN:
        required: true
      OPENAI_API_KEY:
        required: true
      PAT_TOKEN:
        required: true

env:
  SLACK_CHANNEL_ID: C09FDPQ8XPB
  SLACK_PR_CHANNEL_ID: C09VCT4JFU4

jobs:
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: TypeScript check
        run: yarn run check

      # - name: Run linter - disabled for now because the linting takes more then 45min with the flashcard plugin
      #   run: yarn lint

      - name: Build worker
        run: yarn build:worker

      - name: Build application
        run: yarn build

      - name: Install Playwright browsers
        run: yarn playwright install --with-deps chromium

      # - name: Run tests   # temporarily disabled
      #   run: yarn test
      #   env:
      #     RIMORI_TOKEN: ${{ secrets.RIMORI_TOKEN }}
      #     RIMORI_BACKEND_URL: https://dev-api.rimori.se

  notify-build-failure:
    name: Notify Build Failure
    needs: lint-and-build
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification - Build Failure
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "‚ùå ${{ inputs.plugin_name }} Plugin Weekly Release: Build Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå ${{ inputs.plugin_name }} Plugin Weekly Release: Build Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The weekly release pipeline for ${{ inputs.plugin_name }} Plugin has failed due to lint/build failures. The release cannot proceed until all issues are fixed."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Pipeline Run>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nBlocked - Release cannot proceed"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è *Action Required:* Review the build failures, fix the issues, and retrigger the pipeline after resolving them."
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  prepare-release:
    name: Prepare Weekly Release
    needs: lint-and-build
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ steps.branch.outputs.name }}
      changelog: ${{ steps.changelog.outputs.content }}
      date: ${{ steps.date.outputs.value }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock
          registry-url: "https://registry.npmjs.org"

      - name: Get release date
        id: date
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "value=$DATE" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Checkout dev to generate changelog from dev branch
          git checkout dev
          # Capture changelog from stdout (status messages go to stderr)
          CHANGELOG=$(node scripts/generate-weekly-changelog.cjs)
          {
            echo "content<<CHANGELOG_EOF"
            echo "$CHANGELOG"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT

      - name: Configure Git credentials for PAT
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Fetch branches
        run: |
          # Fetch latest changes
          git fetch origin main
          git fetch origin dev

      - name: Get current version from main
        id: current_version
        run: |
          # Get version from main branch to ensure we bump from the correct base
          git checkout main
          git pull origin main
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "value=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version in main: $CURRENT_VERSION"

      - name: Determine next version
        id: version
        env:
          CURRENT_VERSION: ${{ steps.current_version.outputs.value }}
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Determined release version: $NEW_VERSION"

      - name: Create release branch from dev
        id: branch
        run: |
          DATE=$(date +%Y-%m-%d)
          BRANCH_NAME="release/weekly-${DATE}"
          git checkout dev
          git pull origin dev
          git checkout -b "${BRANCH_NAME}"
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: Update package version
        run: |
          # Bump version in package.json to ensure there's always a difference from main
          # This matches rimori-main's approach and ensures the PR can be created
          npm version ${{ steps.version.outputs.version }} --no-git-tag-version
          git add package.json
          if [ -f "package-lock.json" ]; then
            git add package-lock.json
          fi
          if [ -f "yarn.lock" ]; then
            git add yarn.lock
          fi
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          echo "Version bumped to ${{ steps.version.outputs.version }}"

      - name: Push release branch
        run: git push origin ${{ steps.branch.outputs.name }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        id: create-pr
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          base: main
          commit-message: "chore: bump version to ${{ steps.version.outputs.version }}"
          title: "Weekly Release: ${{ inputs.plugin_name }} Plugin - ${{ steps.version.outputs.version }}"
          body: |
            ## Weekly Release: ${{ inputs.plugin_name }} Plugin - ${{ steps.version.outputs.version }}

            ${{ steps.changelog.outputs.content }}

            ---

            **Automated Release**
            - Version: ${{ steps.version.outputs.version }}
            - Date: ${{ steps.date.outputs.value }}
            - Branch: ${{ steps.branch.outputs.name }}
            - Release Channel: ${{ inputs.release_channel }}

            **Please review and merge this PR to proceed with the release.**
          labels: release,weekly-deployment
          delete-branch: false

      - name: Send Slack notification - PR Created
        if: steps.create-pr.outputs.pull-request-number != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_PR_CHANNEL_ID }}
          payload: |
            {
              "text": "‚úÖ ${{ inputs.plugin_name }} Plugin Weekly Release PR Ready for Review",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ ${{ inputs.plugin_name }} Plugin Weekly Release PR Ready for Review"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "A new weekly release pull request for ${{ inputs.plugin_name }} Plugin is ready for review and approval."
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Date:*\n${{ steps.date.outputs.value }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ steps.branch.outputs.name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Pull Request:*\n<${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.create-pr.outputs.pull-request-number }}|View PR #${{ steps.create-pr.outputs.pull-request-number }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nReady for Review"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "üí° *Tip:* React with üëç if you're taking care of reviewing this PR."
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
