name: Plugin Weekly Release

on:
  workflow_call:
    inputs:
      plugin_name:
        description: "Name of the plugin (e.g., flashcards)"
        required: true
        type: string
    secrets:
      RIMORI_TOKEN:
        required: true
      SLACK_BOT_TOKEN:
        required: true
      OPENAI_API_KEY:
        required: true
      PAT_TOKEN:
        required: true

env:
  SLACK_CHANNEL_ID: C09FDPQ8XPB
  SLACK_PR_CHANNEL_ID: C09VCT4JFU4

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect_changes.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Detect code changes
        id: detect_changes
        run: |
          git fetch origin main:main 2>/dev/null || true
          CHANGE_COUNT=$(git log main..dev --pretty=format:"%H" --no-merges | wc -l)
          if [ "$CHANGE_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Detected $CHANGE_COUNT commits since last release."
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No commits since last release. Skipping weekly release."
          fi

  lint-build-test:
    name: Lint, Build, and Test
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: |
          yarn cache clean
          yarn install
          yarn upgrade @rimori/playwright-testing @rimori/client @rimori/react-client --latest

      - name: Print dependency versions
        run: |
          echo "=== Installed Package Versions ==="
          echo "rimori-client: $(yarn list --pattern rimori-client --depth=0 2>/dev/null | grep rimori-client@ || echo 'Not installed')"
          echo "playwright-testing: $(yarn list --pattern playwright-testing --depth=0 2>/dev/null | grep playwright-testing@ || echo 'Not installed')"
          echo "react-client: $(yarn list --pattern react-client --depth=0 2>/dev/null | grep react-client@ || echo 'Not installed')"
          echo "=================================="

      - name: TypeScript check
        run: yarn run check

      - name: Build worker
        run: yarn build:worker

      - name: Build application
        run: yarn build

      - name: Install Playwright browsers
        run: yarn playwright install --with-deps chromium

      - name: Run tests
        run: yarn test
        env:
          RIMORI_TOKEN: ${{ secrets.RIMORI_TOKEN }}

      - name: Fail Slack Notification
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "❌ ${{ inputs.plugin_name }} Plugin Weekly Release: Build or Tests Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "❌ Build/Tests Failed" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "Check the workflow run for details: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>" } }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  prepare-release:
    name: Prepare Weekly Release
    needs: [detect-changes, lint-build-test]
    if: needs.detect-changes.outputs.has_changes == 'true' && needs.lint-build-test.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock

      - name: Configure Git
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Fetch branches
        run: |
          git fetch origin dev
          git fetch origin main

      - name: Create release branch
        id: branch
        run: |
          DATE=$(date +%Y-%m-%d)
          RELEASE_BRANCH="release/weekly-${DATE}"
          git checkout dev
          git pull origin dev
          git checkout -b "$RELEASE_BRANCH"
          echo "RELEASE_BRANCH=$RELEASE_BRANCH" >> $GITHUB_ENV

      - name: Bump version and update lockfile
        id: version
        run: |
          # Get current version from main (just to read it)
          git checkout main
          git pull origin main
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          # Switch to release branch to make changes there
          git checkout ${{ env.RELEASE_BRANCH }}

          # Bump version on release branch
          npm version $NEW_VERSION --no-git-tag-version

          # Sync lockfile with updated package.json version
          echo "Syncing yarn.lock with new version..."
          yarn install

          # Upgrade Rimori packages to latest versions
          echo "Upgrading Rimori packages to latest versions..."
          yarn upgrade @rimori/playwright-testing @rimori/client @rimori/react-client --latest

          # Commit version bump and lockfile
          git add package.json
          [ -f package-lock.json ] && git add package-lock.json
          [ -f yarn.lock ] && git add yarn.lock
          git commit -m "chore: bump version to $NEW_VERSION and update lockfile"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Create git tag
        run: |
          git tag -a "v${{ env.NEW_VERSION }}" -m "Release v${{ env.NEW_VERSION }} - ${{ inputs.plugin_name }} plugin"

      - name: Push release branch
        run: git push origin ${{ env.RELEASE_BRANCH }}

      - name: Push git tag
        run: git push origin "v${{ env.NEW_VERSION }}"

      - name: Generate Changelog
        id: changelog
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          git checkout dev
          CHANGELOG=$(node scripts/generate-weekly-changelog.cjs)
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Pull Request via GitHub API
        id: create_pr
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          API_JSON=$(jq -n \
            --arg title "Weekly Release: ${{ inputs.plugin_name }} Plugin - $NEW_VERSION" \
            --arg head "${{ env.RELEASE_BRANCH }}" \
            --arg base "main" \
            --arg body "## Weekly Release: ${{ inputs.plugin_name }} Plugin - $NEW_VERSION\n\n$CHANGELOG\n\nAutomated PR via CI." \
            '{title: $title, head: $head, base: $base, body: $body, maintainer_can_modify: true}')

          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $PAT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls \
            -d "$API_JSON")

          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r .number)
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "Created PR #$PR_NUMBER"

      - name: Notify Slack for PR Approval
        if: success() && env.PR_NUMBER != 'null'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_PR_CHANNEL_ID }}
          payload: |
            {
              "text": "${{ inputs.plugin_name }} - v${{ env.NEW_VERSION }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ inputs.plugin_name }} - v${{ env.NEW_VERSION }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/pull/${{ env.PR_NUMBER }}|View PR>"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "❌ ${{ inputs.plugin_name }} Plugin Weekly Release Preparation Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "❌ Weekly Release Preparation Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Plugin:*\n${{ inputs.plugin_name }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow Run>"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
