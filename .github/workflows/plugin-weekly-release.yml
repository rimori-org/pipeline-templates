name: Plugin Weekly Release

on:
  workflow_call:
    inputs:
      plugin_name:
        description: "Name of the plugin (e.g., flashcards)"
        required: true
        type: string
      release_channel:
        description: "Release channel (alpha/beta/stable)"
        required: false
        type: string
        default: "alpha"
    secrets:
      RIMORI_TOKEN:
        required: true
      SLACK_BOT_TOKEN:
        required: true
      OPENAI_API_KEY:
        required: true
      PAT_TOKEN:
        required: true

env:
  SLACK_CHANNEL_ID: C09FDPQ8XPB
  SLACK_PR_CHANNEL_ID: C09VCT4JFU4

jobs:
  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: TypeScript check
        run: yarn run check

      - name: Build worker
        run: yarn build:worker

      - name: Build application
        run: yarn build

      - name: Install Playwright browsers
        run: yarn playwright install --with-deps chromium

  notify-build-failure:
    name: Notify Build Failure
    needs: lint-and-build
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification - Build Failure
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "❌ ${{ inputs.plugin_name }} Plugin Weekly Release: Build Failed",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "❌ ${{ inputs.plugin_name }} Plugin Weekly Release: Build Failed" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "The weekly release pipeline for ${{ inputs.plugin_name }} Plugin has failed due to lint/build failures. The release cannot proceed until all issues are fixed." } }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  prepare-release:
    name: Prepare Weekly Release
    needs: lint-and-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock
          registry-url: "https://registry.npmjs.org"

      - name: Configure Git credentials for PAT
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Fetch branches
        run: |
          git fetch origin main
          git fetch origin dev

      - name: Get release date
        id: date
        run: echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Create release branch from dev
        id: branch
        run: |
          RELEASE_BRANCH="release/weekly-${DATE}"
          git checkout dev
          git pull origin dev
          git checkout -b "$RELEASE_BRANCH"
          echo "RELEASE_BRANCH=$RELEASE_BRANCH" >> $GITHUB_ENV

      - name: Get current version from main
        id: current_version
        run: |
          git checkout main
          git pull origin main
          VERSION=$(node -p "require('./package.json').version")
          echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Determine next version
        id: next_version
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Update package version
        run: |
          npm version $NEW_VERSION --no-git-tag-version
          git add package.json
          [ -f package-lock.json ] && git add package-lock.json
          [ -f yarn.lock ] && git add yarn.lock
          git commit -m "chore: bump version to $NEW_VERSION"

      - name: Push release branch
        run: git push origin $RELEASE_BRANCH

      - name: Generate changelog
        id: changelog
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          git checkout dev
          CHANGELOG=$(node scripts/generate-weekly-changelog.cjs)
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Pull Request via API
        id: create_pr
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          API_JSON=$(jq -n \
            --arg title "Weekly Release: ${{ inputs.plugin_name }} Plugin - $NEW_VERSION" \
            --arg head "$RELEASE_BRANCH" \
            --arg base "main" \
            --arg body "## Weekly Release: ${{ inputs.plugin_name }} Plugin - $NEW_VERSION\n\n$CHANGELOG\n\nAutomated release via CI." \
            '{title: $title, head: $head, base: $base, body: $body, maintainer_can_modify: true}')
          
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $PAT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls \
            -d "$API_JSON")
          
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r .number)
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "Created PR #$PR_NUMBER"

      - name: Merge Pull Request via API
        if: env.PR_NUMBER != 'null'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          curl -s -X PUT \
            -H "Authorization: token $PAT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/$PR_NUMBER/merge \
            -d '{"merge_method":"squash"}' | jq

      - name: Send Slack notification - PR Created
        if: env.PR_NUMBER != 'null'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_PR_CHANNEL_ID }}
          payload: |
            {
              "text": "✅ ${{ inputs.plugin_name }} Plugin Weekly Release PR Merged",
              "blocks": [
                { "type": "section", "text": { "type": "mrkdwn", "text": "Weekly release PR #${{ env.PR_NUMBER }} has been merged into main." } }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
