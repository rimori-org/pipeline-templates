name: Plugin Dev Pipeline

on:
  workflow_call:
    inputs:
      plugin_name:
        description: "Name of the plugin (e.g., flashcards)"
        required: true
        type: string
    secrets:
      RIMORI_TOKEN:
        required: true
      SLACK_BOT_TOKEN:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      SLACK_CHANNEL_ID: C09FDPQ8XPB

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "yarn"
          cache-dependency-path: yarn.lock
          registry-url: "https://registry.npmjs.org"

      - name: Get latest pre-release versions
        if: github.event_name == 'push'
        id: versions
        run: |
          # Get @rimori/client@next
          CLIENT_VERSION=$(npm view @rimori/client@next version 2>/dev/null || echo "")
          if [ -z "$CLIENT_VERSION" ]; then
            echo "⚠️  Warning: No @rimori/client@next version found. Using current dependency version."
            CLIENT_VERSION=$(node -p "require('./package.json').dependencies['@rimori/client']")
            CLIENT_VERSION="${CLIENT_VERSION#^}"
          fi
          echo "client_version=$CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "Using @rimori/client version: $CLIENT_VERSION"

          # Get @rimori/react-client@next
          REACT_CLIENT_VERSION=$(npm view @rimori/react-client@next version 2>/dev/null || echo "")
          if [ -z "$REACT_CLIENT_VERSION" ]; then
            echo "⚠️  Warning: No @rimori/react-client@next version found. Using current dependency version."
            REACT_CLIENT_VERSION=$(node -p "require('./package.json').dependencies['@rimori/react-client']")
            REACT_CLIENT_VERSION="${REACT_CLIENT_VERSION#^}"
          fi
          echo "react_client_version=$REACT_CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "Using @rimori/react-client version: $REACT_CLIENT_VERSION"

          # Get @rimori/playwright-testing@next
          PLAYWRIGHT_VERSION=$(npm view @rimori/playwright-testing@next version 2>/dev/null || echo "")
          if [ -z "$PLAYWRIGHT_VERSION" ]; then
            echo "⚠️  Warning: No @rimori/playwright-testing@next version found. Using current dependency version."
            PLAYWRIGHT_VERSION=$(node -p "require('./package.json').devDependencies['@rimori/playwright-testing']")
            PLAYWRIGHT_VERSION="${PLAYWRIGHT_VERSION#^}"
          fi
          echo "playwright_version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "Using @rimori/playwright-testing version: $PLAYWRIGHT_VERSION"

      - name: Restore package.json from git (ignore local changes)
        run: git checkout HEAD -- package.json

      - name: Update dependencies to latest pre-releases
        if: github.event_name == 'push'
        run: |
          # Clear node_modules to prevent cache conflicts
          echo "Clearing node_modules to ensure clean install..."
          rm -rf node_modules

          # Install all dependencies in a single command to prevent version conflicts
          # This ensures @rimori/playwright-testing@next is installed before client packages
          # that might depend on the stable version
          yarn add \
            "@rimori/client@${{ steps.versions.outputs.client_version }}" \
            "@rimori/react-client@${{ steps.versions.outputs.react_client_version }}" \
            "@rimori/playwright-testing@${{ steps.versions.outputs.playwright_version }}" \
            --exact
          echo "Updated dependencies:"
          echo "  @rimori/client: ${{ steps.versions.outputs.client_version }}"
          echo "  @rimori/react-client: ${{ steps.versions.outputs.react_client_version }}"
          echo "  @rimori/playwright-testing: ${{ steps.versions.outputs.playwright_version }}"

      - name: Install dependencies
        run: |
          # For push events (dev releases), we just updated dependencies, so don't use frozen-lockfile
          # For PRs, use frozen-lockfile to ensure reproducible builds
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "Installing dependencies after version updates (no frozen lockfile)..."
            yarn install
          else
            echo "Installing dependencies with frozen lockfile..."
            yarn install --frozen-lockfile
          fi

      - name: Verify correct versions installed
        if: github.event_name == 'push'
        run: |
          echo "Verifying installed versions..."
          INSTALLED_CLIENT=$(node -p "require('./node_modules/@rimori/client/package.json').version")
          INSTALLED_REACT=$(node -p "require('./node_modules/@rimori/react-client/package.json').version")
          INSTALLED_PLAYWRIGHT=$(node -p "require('./node_modules/@rimori/playwright-testing/package.json').version")

          echo "Installed versions:"
          echo "  @rimori/client: $INSTALLED_CLIENT (expected: ${{ steps.versions.outputs.client_version }})"
          echo "  @rimori/react-client: $INSTALLED_REACT (expected: ${{ steps.versions.outputs.react_client_version }})"
          echo "  @rimori/playwright-testing: $INSTALLED_PLAYWRIGHT (expected: ${{ steps.versions.outputs.playwright_version }})"

          # Verify playwright-testing version matches (critical for tests)
          if [ "$INSTALLED_PLAYWRIGHT" != "${{ steps.versions.outputs.playwright_version }}" ]; then
            echo "❌ ERROR: @rimori/playwright-testing version mismatch!"
            echo "   Expected: ${{ steps.versions.outputs.playwright_version }}"
            echo "   Installed: $INSTALLED_PLAYWRIGHT"
            exit 1
          fi

          echo "✅ All versions verified correctly"

      - name: TypeScript check
        run: yarn run check

      - name: Build worker
        run: yarn build:worker

      - name: Build Project
        run: yarn build

      - name: Install Playwright browsers
        if: github.event_name == 'push'
        run: yarn playwright install --with-deps chromium

      - name: Run tests
        if: github.event_name == 'push'
        run: yarn test
        env:
          RIMORI_TOKEN: ${{ secrets.RIMORI_TOKEN }}
          RIMORI_BACKEND_URL: https://dev-api.rimori.se

      # Dev branch releases
      - name: Release Alpha to Dev Environment
        if: github.event_name == 'push'
        env:
          RIMORI_TOKEN: ${{ secrets.RIMORI_TOKEN }}
          RIMORI_BACKEND_URL: https://dev-api.rimori.se
        run: yarn rimori-release alpha

      - name: Release Alpha to Production Environment
        if: github.event_name == 'push'
        env:
          RIMORI_TOKEN: ${{ secrets.RIMORI_TOKEN }}
          RIMORI_BACKEND_URL: https://api.rimori.se
        run: yarn rimori-release alpha

      - name: Notify Slack
        if: job.status != 'cancelled' && (success() || failure())
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "${{ job.status == 'success' && (github.event_name == 'pull_request' && '✅ PR CI Check' || format('✅ {0} Plugin Release', inputs.plugin_name)) || format('❌ {0} Plugin Release Failed', inputs.plugin_name) }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && '✅' || '❌' }} ${{ github.event_name == 'pull_request' && 'PR CI Check' || format('{0} Plugin Release', inputs.plugin_name) }} (${{ github.event_name == 'pull_request' && format('{0} → {1}', github.head_ref, github.base_ref) || github.ref_name }}) ${{ job.status == 'success' && 'Succeeded' || 'Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
